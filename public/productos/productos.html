<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="/images/logo.jpg" alt="tienda de mascotas" class="imagen">
        </header>
        <h1>Lista de Productos</h1>
        <table id="productos-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Producto</th>
                    <th>Existencia</th>
                    <th>Valor unitario venta</th>
                    <th>Valor unitario compra</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas de productos se cargarán aquí -->
            </tbody>
        </table>
        <!-- Modal para editar producto -->
        <div id="editModal" style="display: none;">
            <div style="background-color: white; padding: 20px; border: 1px solid #ddd; width: 500px; margin: 0 auto; margin-top: 100px; position: relative;">
                <h2>Editar Producto</h2>
                <form id="editForm" class="form">
                    <input type="hidden" id="editIdProducto">
                    <div>
                        <label for="producto">Nombre:</label>
                        <input type="text" id="editProducto" required>
                    </div>
                    <div>
                        <label for="existencia">Precio:</label>
                        <input type="number" id="editExistencia" required>
                    </div>
                    <div>
                        <label for="valorunitarioventa">Valor venta:</label>
                        <input type="number" id="editValorventa" required></textarea>
                    </div>
                    <div>
                        <label for="valorunitariocompra">Valor compra:</label>
                        <input type="number" id="editValorcompra" required></textarea>
                    </div>
                    <div class="button-container">
                        <button type="submit">Guardar Cambios</button>
                        <button type="button" onclick="cerrarModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // Función para cargar los productos desde el servidor
        function cargarProductos() {
            fetch('/api/productos')
                .then(response => response.json())
                .then(data => {
                    const tabla = document.getElementById('productos-table').getElementsByTagName('tbody')[0];
                    
                    // Limpiar las filas existentes
                    tabla.innerHTML = '';

                    // Añadir filas de productos
                    data.forEach(producto => {
                        const fila = tabla.insertRow();
                        const celdaId = fila.insertCell(0);
                        const celdaProducto = fila.insertCell(1);
                        const celdaExistencia = fila.insertCell(2);
                        const celdaValorventa = fila.insertCell(3);
                        const celdaValorcompra = fila.insertCell(4);
                        const celdaAcciones = fila.insertCell(5);

                        celdaId.textContent = producto.IdProducto;
                        celdaProducto.textContent = producto.Producto;
                        celdaExistencia.textContent = `$${producto.Existencia}`;
                        celdaValorventa.textContent = `$${producto.Valor_Unitario_Venta}`;
                        celdaValorcompra.textContent = `$${producto.Valor_Unitario_Compra}`;

                        // Iconos de acciones
                        celdaAcciones.innerHTML = `
                            <button class="icon-button" onclick="mostrarEditarProducto(${producto.IdProducto}, '${producto.Producto}', ${producto.Existencia}, ${producto.Valor_Unitario_Venta}, ${producto.Valor_Unitario_Compra})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-button" onclick="eliminarProducto(${producto.IdProducto})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error al cargar productos:', error);
                });
        }

        // Llamar a la función para cargar productos cuando se cargue la página
        window.onload = cargarProductos;

        function eliminarProducto(id) {
            if (confirm(`¿Está seguro de que desea eliminar el producto con ID: ${id}?`)) {
                fetch(`/api/productos/${id}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        alert('Producto eliminado exitosamente');
                        cargarProductos(); // Recargar la tabla después de eliminar
                    } else {
                        alert('Error al eliminar el producto');
                    }
                })
                .catch(error => {
                    console.error('Error al eliminar producto:', error);
                });
            }
        }
    
        // Mostrar el modal de edición con los datos del producto
        function mostrarEditarProducto(id, producto, existencia, valorventa, valorcompra) {
            document.getElementById('editIdProducto').value = id;
            document.getElementById('editProducto').value = producto;
            document.getElementById('editExistencia').value = existencia;
            document.getElementById('editValorventa').value = valorventa;
            document.getElementById('editValorcompra').value = valorcompra;

            // Mostrar el modal
            document.getElementById('editModal').style.display = 'block';
        }

        // Cerrar el modal de edición
        function cerrarModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Manejar el envío del formulario de edición
        document.getElementById('editForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevenir el envío del formulario por defecto

        const id = document.getElementById('editIdProducto').value;
        const producto = document.getElementById('editProducto').value;
        const existencia = document.getElementById('editExistencia').value;
        const valorunitarioventa = document.getElementById('editValorventa').value;
        const valorunitariocompra = document.getElementById('editValorcompra').value;


        fetch(`/api/productos/${id}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ producto, existencia, valorunitarioventa, valorunitariocompra })
        })
        .then(response => {
            if (response.ok) {
                alert('Producto actualizado exitosamente');
                cargarProductos(); // Recargar la tabla después de actualizar
                cerrarModal(); // Cerrar el modal después de la actualización
            } else {
                alert('Error al actualizar el producto');
            }
        })
        .catch(error => {
            console.error('Error al actualizar producto:', error);
        });
});
    </script>
</body>
</html>